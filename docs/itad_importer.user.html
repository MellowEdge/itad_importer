<!DOCTYPE html>

<html>
<head>
  <title>itad_importer.user.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>itad_importer.user.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h2 id="isthereanydeal-com-collection-importer">IsThereAnyDeal.com Collection Importer</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-regexp">//</span> ==UserScript==
<span class="hljs-regexp">//</span> @name IsThereAnyDeal.com Collection Importer
<span class="hljs-regexp">//</span> @version <span class="hljs-number">0.1</span>b18
<span class="hljs-regexp">//</span> @namespace http:<span class="hljs-regexp">//i</span>sthereanydeal.com/
<span class="hljs-regexp">//</span> @description Adds buttons to various sites to <span class="hljs-keyword">export</span> your game lists to ITAD
<span class="hljs-regexp">//</span> @icon http:<span class="hljs-regexp">//</span>s3-eu-west<span class="hljs-number">-1.</span>amazonaws.com/itad/images/banners/<span class="hljs-number">50</span>x50.gif
<span class="hljs-regexp">//</span> @license MIT
<span class="hljs-regexp">//</span> @supportURL https:<span class="hljs-regexp">//gi</span>thub.com/ssokolow/itad_importer/issues
<span class="hljs-regexp">//</span> @require https:<span class="hljs-regexp">//</span>ajax.googleapis.com/ajax/libs/jquery/<span class="hljs-number">1.11</span><span class="hljs-number">.0</span>/jquery.min.js
<span class="hljs-regexp">//</span>
<span class="hljs-regexp">//</span> @match *:<span class="hljs-regexp">//</span>fireflowergames.com/my-account*
<span class="hljs-regexp">//</span> @match *:<span class="hljs-regexp">//</span>fireflowergames.com<span class="hljs-regexp">/my-lists/</span>*
<span class="hljs-regexp">//</span> @match *:<span class="hljs-regexp">//</span>flyingbundle.com/users/account*
<span class="hljs-regexp">//</span> @match *:<span class="hljs-regexp">//</span>www.flyingbundle.com/users/account*
<span class="hljs-regexp">//</span> @match *:<span class="hljs-regexp">//</span>www.gog.com/account*
<span class="hljs-regexp">//</span> @match *:<span class="hljs-regexp">//</span>www.gog.com<span class="hljs-regexp">/order/status/</span>*
<span class="hljs-regexp">//</span> @match *:<span class="hljs-regexp">//g</span>roupees.com/purchases*
<span class="hljs-regexp">//</span> @match *:<span class="hljs-regexp">//g</span>roupees.com<span class="hljs-regexp">/users/</span>*
<span class="hljs-regexp">//</span> @match *:<span class="hljs-regexp">//</span>www.humblebundle.com/home*
<span class="hljs-regexp">//</span> @match *:<span class="hljs-regexp">//</span>www.humblebundle.com/downloads?key=*
<span class="hljs-regexp">//</span> @match *:<span class="hljs-regexp">//</span>www.humblebundle.com/s?key=*
<span class="hljs-regexp">//</span> ==/UserScript==

Any patches to <span class="hljs-keyword">this</span> script should be made against the original
CoffeeScript source file available (<span class="hljs-keyword">and</span> documented) at:

  https:<span class="hljs-regexp">//gi</span>thub.com/ssokolow/itad_importer

Copyright ©<span class="hljs-number">2014</span><span class="hljs-number">-2018</span> Stephan Sokolow
License: MIT (http:<span class="hljs-regexp">//</span>opensource.org/licenses/MIT)

TODO:
- Add a `<span class="javascript">@downloadURL</span>` <span class="hljs-keyword">for</span> the script</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>##</p>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>This string will be interpreted as raw HTML</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>BUTTON_LABEL = <span class="hljs-string">"Export to ITAD"</span>

ITAD_12X12 = <span class="hljs-string">"""data:image/png;base64,
iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAMAAABhq6zVAAAAZlBMVEUEbrIEbrIJcbQLcrQefboo
g70rhb4thr8vh78zicA6jcNCksVLl8hWnctZn8xdoc1ipM9ipc9kptB5stZ6staCt9mHutqJu9ud
xuGozeSrz+W72OrA2+zJ4O7U5vLX6PPn8fj3+vyC0mvkAAAAAXRSTlMAQObYZgAAAFdJREFUCB0F
wYkCgUAABcA3CpElRyRH6/9/0kwCQALtZSwNglN9Pt5LR+jqGuelEaYbeBXh04P7KMwDeF6E8l1h
W1vh8PsO/bWeiGPdl/kzdYjdBkACQP5LygQ7CM8T6wAAAABJRU5ErkJggg=="""</span>

ITAD_14X14_GRAY = <span class="hljs-string">"""data:image/png;base64,
iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAMAAAAolt3jAAAAdVBMVEUEbrKTlaCTlZ+TlZ+UlqCY
maSYmqWcnqednqieoKmfoaugoqulprCvsLivsbiwsrmztLuztby2uL7BwsjDxcrExcvIyc7V1trW
1trX2Nvn5+rp6evx8vP19fb39/j4+Pn5+fr7+/v7+/z8/Pz8/P39/f3///8J+FboAAAAJHRSTlMA
y+rw8PHx8fHx8vLy9PT09PT19vf39/n5+fz8/f3+/v7+/v695LIzAAAAcUlEQVQIHQXBhwGCQAAE
sHui2FHsBeyy/4gmSQGgJKWCeTNFVQJNN9yH2xJB+z3WZuf3kjDuD+B8I6wfIzAbpsLuCrg3QtsD
9TAXJq8tOHYEl9+W0eHbEPaf06u/PvoWsXmuTNrdegwp1QJAVZICQMkf1qQG7Yh+Z60AAAAASUVO
RK5CYII="""</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Prevent conflict between our jQuery and site jQuery without using @grant</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">this</span>.$ = <span class="hljs-keyword">this</span>.jQuery = jQuery.noConflict(<span class="hljs-literal">true</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Less overhead than instantiating a new jQuery object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">attr</span> = <span class="hljs-params">(node, name)</span> -&gt;</span> node.getAttribute(name)
<span class="hljs-function">
<span class="hljs-title">gog_prepare_title</span> = <span class="hljs-params">(elem)</span> -&gt;</span>
  dom = $(<span class="hljs-string">'.product-title'</span>, elem).clone()
  $(<span class="hljs-string">'._product-flag'</span>, dom).remove()
  dom.text()
<span class="hljs-function">
<span class="hljs-title">humble_make_button</span> = -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Humble Library uses very weird button markup</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  label = $(<span class="hljs-string">'&lt;span class="label"&gt;&lt;/span&gt;'</span>).html(BUTTON_LABEL)
  a = $(<span class="hljs-string">'&lt;a class="a" href="#"&gt;&lt;/span&gt;'</span>)
    .html(BUTTON_LABEL)</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Apparently the <code>noicon</code> class isn’t versatile enough</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    .css(<span class="hljs-string">'padding-left'</span>, <span class="hljs-string">'9px'</span>)

  button = $(<span class="hljs-string">'&lt;div class="flexbtn active noicon"&gt;&lt;/div&gt;'</span>)
  .append(<span class="hljs-string">'&lt;div class="right"&gt;&lt;/div&gt;'</span>)
  .append(label)
  .append(a)
<span class="hljs-function">
<span class="hljs-title">humble_parse</span> = -&gt;</span> {
  version: <span class="hljs-string">"02"</span>,
  data: {
    title: x.textContent.trim(),
    copies: [{ type: <span class="hljs-string">'humblestore'</span> }]
  } <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> $(<span class="hljs-string">'div.row'</span>).has(</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Humble Library has no easy way to list only games</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-string">' .downloads.windows .download,
      .downloads.linux .download,
      .downloads.mac .download,
      .downloads.android .download'</span>
  ).find(<span class="hljs-string">'div.title'</span>)}</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Scrapers are looked up first by domain (lightweight) and then by
a regex check on the URL (accurate).
This should allow for extremely robust scaling as well as enabling the
possibility of a build script which automatically generates the
Greasemonkey <code>@include</code> lines.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>scrapers =
  <span class="hljs-string">'fireflowergames.com'</span>:
    <span class="hljs-string">'^https://fireflowergames\\.com/my-account/?'</span>:
      <span class="hljs-string">'source_id'</span>: <span class="hljs-string">'fireflower'</span>
      <span class="hljs-string">'game_list'</span>: <span class="hljs-function">-&gt;</span>
        results = $(<span class="hljs-string">'ul.digital-downloads li a'</span>)
        titles = [$(x).text().split(<span class="hljs-string">" – "</span>)[<span class="hljs-number">0</span>].trim() <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> results][<span class="hljs-number">0</span>]
        uniques = titles.filter(<span class="hljs-function"><span class="hljs-params">(title, pos)</span> -&gt;</span>  titles.indexOf(title) == pos)</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>TODO: Take screenshot</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        {
          version: <span class="hljs-string">"02"</span>,
          data: {
            title: title,
            copies: [{
              type: <span class="hljs-string">'fireflower'</span>,
              status: <span class="hljs-string">'redeemed'</span>,
              owned: <span class="hljs-number">1</span>,
            }]
          } <span class="hljs-keyword">for</span> title <span class="hljs-keyword">in</span> uniques
        }
      <span class="hljs-string">'insert_button'</span>: <span class="hljs-function">-&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>XXX: If you can debug the broken behaviour with <button>, please do.
I don’t have time.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        $(<span class="hljs-string">'&lt;a class="button"&gt;&lt;/a&gt;'</span>)
          .html(BUTTON_LABEL)
          .css({
            verticalAlign: <span class="hljs-string">'20%'</span>,
            marginLeft: <span class="hljs-string">'1em'</span>,
          }).appendTo($(<span class="hljs-string">'ul.digital-downloads'</span>).prev())

    <span class="hljs-string">'^http://fireflowergames\\.com/my-lists/(edit-my|view-a)-list/\\?.+'</span>:
      <span class="hljs-string">'source_id'</span>: <span class="hljs-string">'fireflower'</span>
      <span class="hljs-string">'game_list'</span>: <span class="hljs-function">-&gt;</span>
        results = $(<span class="hljs-string">'table.wl-table tbody td.check-column input:checked'</span>)
          .parents(<span class="hljs-string">'tr'</span>).find(<span class="hljs-string">'td.product-name a'</span>)

        <span class="hljs-keyword">if</span> (!results.length)
          results = $(<span class="hljs-string">'table.wl-table td.product-name a'</span>)

        {
          version: <span class="hljs-string">"02"</span>,
          data: { title: $(x).text().trim() } <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> results
        }
      <span class="hljs-string">'insert_button'</span>: <span class="hljs-function">-&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>XXX: If you can debug the broken behaviour with <button>, please do.
I don’t have time.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        $(<span class="hljs-string">'&lt;a class="button"&gt;&lt;/a&gt;'</span>)
          .html(BUTTON_LABEL)
          .wrap(<span class="hljs-string">'&lt;td&gt;&lt;/td&gt;'</span>)
          .appendTo($(<span class="hljs-string">'table.wl-actions-table tbody:first'</span>).find(<span class="hljs-string">'tr:last'</span>))
      <span class="hljs-string">'is_wishlist'</span>: <span class="hljs-literal">true</span>

  <span class="hljs-string">'flyingbundle.com'</span>:
    <span class="hljs-string">'https?://(www\\.)?flyingbundle\\.com/users/account#?'</span>:
      <span class="hljs-string">'source_id'</span>: <span class="hljs-string">'flying_bundle'</span>
      <span class="hljs-string">'game_list'</span>: <span class="hljs-function">-&gt;</span> {
        version: <span class="hljs-string">"02"</span>,
        data: {
          title: $(x).text(),
          copies: [{
            type: <span class="hljs-string">'Flying Bundle'</span>,
            status: <span class="hljs-string">'redeemed'</span>,
            owned: <span class="hljs-number">1</span>,
            source: {
              type: <span class="hljs-string">"s"</span>,
              id: <span class="hljs-string">"other"</span>
            }
          }]
        } <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> $(<span class="hljs-string">".div_btn_download[href^='/users/sources']"</span>
        ).parents(<span class="hljs-string">'li'</span>).find(<span class="hljs-string">':first'</span>)
      }
      <span class="hljs-string">'insert_button'</span>: <span class="hljs-function">-&gt;</span>
        li = $(<span class="hljs-string">"&lt;li&gt;&lt;/li&gt;"</span>
        ).appendTo(<span class="hljs-string">'.legenda_points ul'</span>)
        $(<span class="hljs-string">'&lt;a href="#"&gt;'</span> + BUTTON_LABEL + <span class="hljs-string">' &lt;img src="'</span> + ITAD_14X14_GRAY +
          <span class="hljs-string">'" /&gt;&lt;/a&gt;'</span>)
          .css(<span class="hljs-string">'text-transform'</span>, <span class="hljs-string">'uppercase'</span>)
          .wrap(<span class="hljs-string">"&lt;li&gt;&lt;/li&gt;"</span>)
          .appendTo(li)

  <span class="hljs-string">'www.gog.com'</span>:
    <span class="hljs-string">'^https://www\\.gog\\.com/order/status/.+'</span>:
      <span class="hljs-string">'source_id'</span>: <span class="hljs-string">'gog'</span>
      <span class="hljs-string">'game_list'</span>: <span class="hljs-function">-&gt;</span>
        <span class="hljs-built_in">console</span>.debug(<span class="hljs-string">"game_list called for GOG order status page"</span>)
        {
          <span class="hljs-string">"version"</span>: <span class="hljs-string">"02"</span>,
          <span class="hljs-string">"data"</span>: {
            title: gog_prepare_title(x)
            copies: [{
              type: <span class="hljs-string">'gog'</span>,
              status: <span class="hljs-string">'redeemed'</span>,
              owned: <span class="hljs-number">1</span>,
            }]
          } <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> $(<span class="hljs-string">'.order + .container .product-row'</span>)
        }

      <span class="hljs-string">'insert_button'</span>: <span class="hljs-function">-&gt;</span>
        <span class="hljs-built_in">console</span>.debug(<span class="hljs-string">"insert_button called for GOG order status page"</span>)
        $(<span class="hljs-string">".order-article__btn-pointer-wrapper .order-article__btn-pointer"</span>)
          .css({
            marginTop: <span class="hljs-number">-4</span>,
            zIndex: <span class="hljs-number">20</span>,
          })
        $(<span class="hljs-string">'.order-article__dropdown-items'</span>).css(<span class="hljs-string">'z-index'</span>, <span class="hljs-number">10</span>)
        $(<span class="hljs-string">"&lt;a class='_dropdown__item ng-scope'&gt;&lt;/a&gt;"</span>)
          .html(<span class="hljs-string">"On ITAD"</span>)
          .prependTo($(<span class="hljs-string">'.order-message__actions ._dropdown__items'</span>)
            .filter(<span class="hljs-string">':first'</span>))

    <span class="hljs-string">'^https?://www\\.gog\\.com/account(/games(/(shelf|list))?)?/?(\\?|$)'</span>:
      <span class="hljs-string">'source_id'</span>: <span class="hljs-string">'gog'</span>
      <span class="hljs-string">'game_list'</span>: <span class="hljs-function">-&gt;</span>
        <span class="hljs-built_in">console</span>.debug(<span class="hljs-string">"game_list called for GOG collection page"</span>)
        {
          <span class="hljs-string">"version"</span>: <span class="hljs-string">"02"</span>,
          <span class="hljs-string">"data"</span>: {</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>id: attr(x, ‘gog-account-product’)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            title: gog_prepare_title(x)
            copies: [{
              type: <span class="hljs-string">'gog'</span>,
              status: <span class="hljs-string">'redeemed'</span>,
              owned: <span class="hljs-number">1</span>,
            }]
          } <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> $(<span class="hljs-string">'.product-row'</span>)
        }

      <span class="hljs-string">'insert_button'</span>: <span class="hljs-function">-&gt;</span>
        <span class="hljs-built_in">console</span>.debug(<span class="hljs-string">"insert_button called for GOG collection page"</span>)
        $(<span class="hljs-string">"&lt;span&gt;&lt;/span&gt;"</span>)
        .css
          float: <span class="hljs-string">'right'</span>
          cursor: <span class="hljs-string">'pointer'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>TODO: Replace the following hacks with whatever GOG uses</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          position: <span class="hljs-string">'relative'</span>
          marginBottom: <span class="hljs-string">'-2em'</span>
          zIndex: <span class="hljs-number">1</span>
        .html(BUTTON_LABEL + <span class="hljs-string">" (This Page)"</span>)
        .prependTo($(<span class="hljs-string">'.collection-header'</span>).filter(<span class="hljs-string">':first'</span>))

  <span class="hljs-string">'groupees.com'</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>TODO: Support the new UI beta</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-string">'https?://(www\\.)?groupees\\.com/(purchases|users/\\d+)'</span>:
      <span class="hljs-string">'source_id'</span>: <span class="hljs-string">'other'</span>
      <span class="hljs-string">'game_list'</span>: <span class="hljs-function">-&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>FIXME: Now I need to manually filter for actual games</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        {
          <span class="hljs-string">"version"</span>: <span class="hljs-string">"02"</span>,
          <span class="hljs-string">"data"</span>: {
            title: x.textContent.trim(),
            copies: [{
              type: <span class="hljs-string">'Groupees.com'</span>,
              status: <span class="hljs-string">'redeemed'</span>,
              owned: <span class="hljs-number">1</span>,
              source: {
                type: <span class="hljs-string">"s"</span>,
                id: <span class="hljs-string">"other"</span>
              }
            }]
          } <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> $(<span class="hljs-string">'.product ul.dropdown-menu'</span>)
                      .parents(<span class="hljs-string">'.details'</span>).find(<span class="hljs-string">'h3'</span>)
        }
      <span class="hljs-string">'insert_button'</span>: <span class="hljs-function">-&gt;</span>
        $(<span class="hljs-string">"&lt;button&gt;&lt;/button&gt;"</span>)
          .css({ float: <span class="hljs-string">'right'</span> }).addClass(<span class="hljs-string">'button btn btn-sm btn-primary'</span>)
          .html(BUTTON_LABEL + <span class="hljs-string">" (Selected Bundle)"</span>)
          .insertBefore(<span class="hljs-string">"input[name='search']"</span>)

  <span class="hljs-string">'www.humblebundle.com'</span>:
    <span class="hljs-string">'https://www\\.humblebundle\\.com/home/library/?'</span>:
      <span class="hljs-string">'source_id'</span>: <span class="hljs-string">'humblestore'</span>
      <span class="hljs-string">'game_list'</span>: <span class="hljs-function">-&gt;</span> {
        <span class="hljs-string">"version"</span>: <span class="hljs-string">"02"</span>,
        <span class="hljs-string">"data"</span>: {
          title: x.textContent.trim(),
          copies: [{
            type: <span class="hljs-string">'humblestore'</span>,
            status: <span class="hljs-string">'redeemed'</span>,
            owned: <span class="hljs-number">1</span>,
          }]
        } <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> $(<span class="hljs-string">'.subproduct-selector h2'</span>)
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>TODO: Figure out how to filter out non-games again
TODO: Figure out how to tap their Backbone.js store</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
      <span class="hljs-string">'insert_button'</span>: <span class="hljs-function">-&gt;</span>
        config = { childList: <span class="hljs-literal">true</span>, subtree: <span class="hljs-literal">true</span> }
        button = $(<span class="hljs-string">'&lt;button class="download-button"&gt;&lt;/button&gt;'</span>)
          .html(BUTTON_LABEL)
          .css</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>I wish they wouldn’t make their CSS rules so specific</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            display: <span class="hljs-string">'inline'</span>,
            border: <span class="hljs-string">'1px solid #CCC'</span>,
            background: <span class="hljs-string">'#F1F3F6'</span>,
            padding: <span class="hljs-string">'5px 10px 5px 10px'</span>,
            marginLeft: <span class="hljs-string">'10px'</span>,

        found_early = $(<span class="hljs-string">".top-controls"</span>)
        <span class="hljs-keyword">if</span> found_early.length &gt; <span class="hljs-number">0</span>
          <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Inserting button immediately."</span>)
          button.appendTo(found_early)
        <span class="hljs-keyword">else</span>
          <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Using MutationObserver for deferred button insertion."</span>)
          observer = <span class="hljs-keyword">new</span> MutationObserver(<span class="hljs-function"><span class="hljs-params">(mutations)</span> -&gt;</span>
            mutations.forEach(<span class="hljs-function"><span class="hljs-params">(mutation)</span> -&gt;</span>
              tnode_cls = mutation.target.getAttribute(<span class="hljs-string">"class"</span>)
              found = $(<span class="hljs-string">".top-controls"</span>, mutation.target)
              <span class="hljs-keyword">if</span> found.length &gt; <span class="hljs-number">0</span>
                observer.disconnect()
                button.appendTo(found)
            )
          )
          observer.observe(<span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">'.js-library-holder'</span>),
                           config)
        <span class="hljs-keyword">return</span> button

    <span class="hljs-string">'https://www\\.humblebundle\\.com/home/?'</span>:
      <span class="hljs-string">'source_id'</span>: <span class="hljs-string">'humblestore'</span>
      <span class="hljs-string">'game_list'</span>: humble_parse
      <span class="hljs-string">'insert_button'</span>: <span class="hljs-function">-&gt;</span>
        humble_make_button().css
          float: <span class="hljs-string">'right'</span>,
          fontSize: <span class="hljs-string">'14px'</span>,
          fontWeight: <span class="hljs-string">'normal'</span>
        .prependTo(<span class="hljs-string">'.base-main-wrapper h1'</span>)

    <span class="hljs-string">'https://www\\.humblebundle\\.com/(download)?s\\?key=.+'</span>:
      <span class="hljs-string">'source_id'</span>: <span class="hljs-string">'humblestore'</span>
      <span class="hljs-string">'game_list'</span>: humble_parse
      <span class="hljs-string">'insert_button'</span>: <span class="hljs-function">-&gt;</span>
        parent = $(<span class="hljs-string">'.js-gamelist-holder'</span>).parents(<span class="hljs-string">'.whitebox'</span>)
        parent.find(<span class="hljs-string">'.staple.s4'</span>).remove()

        humble_make_button().css
          position: <span class="hljs-string">'absolute'</span>
          top: <span class="hljs-number">11</span>
          right: <span class="hljs-number">17</span>
        .appendTo(parent)

scrapers[<span class="hljs-string">'www.flyingbundle.com'</span>] = scrapers[<span class="hljs-string">'flyingbundle.com'</span>]
scrapers[<span class="hljs-string">'www.groupees.com'</span>] = scrapers[<span class="hljs-string">'groupees.com'</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Callback for the button</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">scrapeGames</span> = <span class="hljs-params">(scraper_obj)</span> -&gt;</span>
  params = {
    file: btoa(unescape(encodeURIComponent(JSON.stringify(
      scraper_obj.game_list())))),
    upload: <span class="hljs-string">'x'</span>
  }

  url = <span class="hljs-keyword">if</span> scraper_obj.is_wishlist?
    <span class="hljs-string">'https://isthereanydeal.com/waitlist/import/'</span>
  <span class="hljs-keyword">else</span>
    <span class="hljs-string">'https://isthereanydeal.com/collection/import/'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p><strong>TODO:</strong> Figure out why attempting to use an iframe for non-HTTPS sites
navigates the top-level window.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  form = $(<span class="hljs-string">"&lt;form id='itad_submitter' method='POST' /&gt;"</span>).attr(<span class="hljs-string">'action'</span>, url)
  params[<span class="hljs-string">'returnTo'</span>] = location.href</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Submit the form data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  form.css({ display: <span class="hljs-string">'none'</span> })
  $.each params, <span class="hljs-function"><span class="hljs-params">(key, value)</span> -&gt;</span>
    $(<span class="hljs-string">"&lt;input type='hidden' /&gt;"</span>)
      .attr(<span class="hljs-string">"name"</span>, key)
      .attr(<span class="hljs-string">"value"</span>, value)
      .appendTo(form)
  $(<span class="hljs-built_in">document</span>.body).append(form)

  form.submit()</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>CoffeeScript shorthand for <code>$(document).ready(function() {</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>$ -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Resolve and call the correct profile</p>
<p>It seems we don’t need an explicit <code>if location.host of scrapers</code>
before the <code>for</code> loop</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Loading ITAD importer..."</span>)
  <span class="hljs-keyword">if</span> scrapers[location.host]
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Matched domain: "</span> + location.host)
    <span class="hljs-keyword">for</span> regex, profile <span class="hljs-keyword">of</span> scrapers[location.host]
      <span class="hljs-keyword">try</span>
        profile_matched = location.href.match(regex)
      <span class="hljs-keyword">catch</span> e
        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Bad regex: "</span> + regex)

      <span class="hljs-keyword">if</span> profile_matched
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Matched profile: "</span> + regex)</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Allow reloading the script without reloading the page for RAD</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        $(<span class="hljs-string">'.itad_btn, #itad_dlg, .itad_close'</span>).remove()</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Simplify the following code</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> Array.isArray(profile)
          profile = [profile]

        <span class="hljs-keyword">for</span> scraper <span class="hljs-keyword">in</span> profile</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>We’ll need a closure to ensure click() calls the proper scraper</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">do</span> (scraper) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Use the <code>?</code> existential operator to die quietly if the scraper
doesn’t have an <code>insert_button</code> member.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Inserting ITAD button for source ID: "</span> +
                        scraper.source_id)
            scraper.insert_button?().addClass(<span class="hljs-string">'itad_btn'</span>).click -&gt;
              <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"ITAD button clicked"</span>)
              scrapeGames(scraper)</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>We only ever want to match one profile so break here</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">break</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
