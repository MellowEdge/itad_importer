<!DOCTYPE html>

<html>
<head>
  <title>itad_importer.user.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>itad_importer.user.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h2 id="isthereanydeal-com-collection-importer">IsThereAnyDeal.com Collection Importer</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>
Any patches to <span class="hljs-keyword">this</span> script should be made against the original
CoffeeScript source file available (<span class="hljs-keyword">and</span> documented) <span class="hljs-attribute">at</span>:

  <span class="hljs-attribute">https</span>:<span class="hljs-regexp">//gi</span>thub.com/ssokolow/itad_importer

Copyright ©<span class="hljs-number">2014</span> Stephan Sokolow
<span class="hljs-attribute">License</span>: MIT (<span class="hljs-attribute">http</span>:<span class="hljs-regexp">//</span>opensource.org/licenses/MIT)

<span class="hljs-attribute">TODO</span>:
- Add a `<span class="javascript">@downloadURL</span>` <span class="hljs-keyword">for</span> the script

<span class="hljs-attribute">Note</span>: While we <span class="hljs-keyword">do</span> <span class="hljs-keyword">not</span> use GM_info, we must request it to force the userscript
to be isolated from the page so its jQuery doesn<span class="hljs-string">'t collide with the site'</span>s
jQuery.

<span class="hljs-regexp">//</span> ==UserScript==
<span class="hljs-regexp">//</span> <span class="hljs-property">@name</span> IsThereAnyDeal.com Collection Importer
<span class="hljs-regexp">//</span> <span class="hljs-property">@version</span> <span class="hljs-number">0.1</span>b4
<span class="hljs-regexp">//</span> <span class="hljs-property">@namespace</span> <span class="hljs-attribute">http</span>:<span class="hljs-regexp">//i</span>sthereanydeal.com/
<span class="hljs-regexp">//</span> <span class="hljs-property">@description</span> Adds buttons to various sites to <span class="hljs-reserved">export</span> your game lists to ITAD
<span class="hljs-regexp">//</span> <span class="hljs-property">@icon</span> <span class="hljs-attribute">http</span>:<span class="hljs-regexp">//</span>s3-eu-west-<span class="hljs-number">1.</span>amazonaws.com/itad/images/banners/<span class="hljs-number">50</span>x50.gif
<span class="hljs-regexp">//</span> <span class="hljs-property">@grant</span> GM_info
<span class="hljs-regexp">//</span> <span class="hljs-property">@require</span> <span class="hljs-attribute">https</span>:<span class="hljs-regexp">//</span>ajax.googleapis.com/ajax/libs/jquery/<span class="hljs-number">1.11</span><span class="hljs-number">.0</span>/jquery.min.js
<span class="hljs-regexp">//</span>
<span class="hljs-regexp">//</span> <span class="hljs-property">@match</span> *:<span class="hljs-regexp">//</span>www.dotemu.com/*
<span class="hljs-regexp">//</span> <span class="hljs-property">@match</span> *:<span class="hljs-regexp">//</span>fireflowergames.com<span class="hljs-regexp">/my-lists/</span>*
<span class="hljs-regexp">//</span> <span class="hljs-property">@match</span> *:<span class="hljs-regexp">//</span>secure.gog.com/account*
<span class="hljs-regexp">//</span> <span class="hljs-property">@match</span> *:<span class="hljs-regexp">//</span>secure.gog.com/checkout*
<span class="hljs-regexp">//</span> <span class="hljs-property">@match</span> *:<span class="hljs-regexp">//g</span>roupees.com<span class="hljs-regexp">/users/</span>*
<span class="hljs-regexp">//</span> <span class="hljs-property">@match</span> *:<span class="hljs-regexp">//</span>www.humblebundle.com/home*
<span class="hljs-regexp">//</span> <span class="hljs-property">@match</span> *:<span class="hljs-regexp">//</span>www.humblebundle.com/downloads?key=*
<span class="hljs-regexp">//</span> <span class="hljs-property">@match</span> *:<span class="hljs-regexp">//</span>www.humblebundle.com/s?key=*
<span class="hljs-regexp">//</span> <span class="hljs-property">@match</span> *:<span class="hljs-regexp">//i</span>ndiegamestand.com/wallet.php
<span class="hljs-regexp">//</span> <span class="hljs-property">@match</span> *:<span class="hljs-regexp">//</span>www.shinyloot.com/m/games*
<span class="hljs-regexp">//</span> <span class="hljs-property">@match</span> *:<span class="hljs-regexp">//</span>www.shinyloot.com/m/wishlist*
<span class="hljs-regexp">//</span> ==/UserScript==</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h1 id="-">#</h1>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>This string will be interpreted as raw HTML</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>BUTTON_LABEL = <span class="hljs-string">"Export to ITAD"</span>

ITAD_12X12 = <span class="hljs-string">"""data:image/png;base64,
iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAMAAABhq6zVAAAAZlBMVEUEbrIEbrIJcbQLcrQefboo
g70rhb4thr8vh78zicA6jcNCksVLl8hWnctZn8xdoc1ipM9ipc9kptB5stZ6staCt9mHutqJu9ud
xuGozeSrz+W72OrA2+zJ4O7U5vLX6PPn8fj3+vyC0mvkAAAAAXRSTlMAQObYZgAAAFdJREFUCB0F
wYkCgUAABcA3CpElRyRH6/9/0kwCQALtZSwNglN9Pt5LR+jqGuelEaYbeBXh04P7KMwDeF6E8l1h
W1vh8PsO/bWeiGPdl/kzdYjdBkACQP5LygQ7CM8T6wAAAABJRU5ErkJggg=="""</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Less overhead than instantiating a new jQuery object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">attr</span> = <span class="hljs-params">(node, name)</span> -&gt;</span> node.getAttribute(name)

<span class="hljs-function"><span class="hljs-title">dotemu_add_button</span> = <span class="hljs-params">(parent_selector)</span> -&gt;</span>
  $(<span class="hljs-string">'&lt;button&gt;&lt;/button&gt;'</span>)
  .html(BUTTON_LABEL).css</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>DotEmu doesn’t have a general button style we can use</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">float</span>: <span class="hljs-string">'right'</span>
    <span class="hljs-attribute">marginRight</span>: <span class="hljs-string">'5px'</span>
  .appendTo(parent_selector)</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Common code to extract metadata from the GOG.com shelf and wishlist views</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">gog_nonlist_parse</span> = -&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>The shelf view mode only sees game IDs and slugs easily</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">id</span>: attr(x, <span class="hljs-string">'data-gameid'</span>)
  <span class="hljs-attribute">url</span>: (<span class="hljs-string">'http://www.gog.com/en/game/'</span> + attr(x, <span class="hljs-string">'data-gameindex'</span>))
  <span class="hljs-attribute">sources</span>: [<span class="hljs-string">'gog'</span>]
} <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> $(<span class="hljs-string">'[data-gameindex]'</span>)

<span class="hljs-function"><span class="hljs-title">humble_make_button</span> = -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Humble Library uses very weird button markup</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  label = $(<span class="hljs-string">'&lt;span class="label"&gt;&lt;/span&gt;'</span>).html(BUTTON_LABEL)
  a = $(<span class="hljs-string">'&lt;a class="a" href="#"&gt;&lt;/span&gt;'</span>)
     .html(BUTTON_LABEL)</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Apparently the <code>noicon</code> class isn’t versatile enough</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>     .css(<span class="hljs-string">'padding-left'</span>, <span class="hljs-string">'9px'</span>)

  button = $(<span class="hljs-string">'&lt;div class="flexbtn active noicon"&gt;&lt;/div&gt;'</span>)
  .append(<span class="hljs-string">'&lt;div class="right"&gt;&lt;/div&gt;'</span>)
  .append(label)
  .append(a)

<span class="hljs-function"><span class="hljs-title">humble_parse</span> = -&gt;</span> { <span class="hljs-attribute">title</span>: x.textContent.trim(), <span class="hljs-attribute">sources</span>: [<span class="hljs-string">'humblestore'</span>]
  } <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> $(<span class="hljs-string">'div.row'</span>).has(</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Humble Library has no easy way to list only games</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-string">' .downloads.windows .download,
    .downloads.linux .download,
    .downloads.mac .download,
    .downloads.android .download'</span>
  ).find(<span class="hljs-string">'div.title'</span>)

<span class="hljs-function"><span class="hljs-title">shinyloot_insert_button</span> = -&gt;</span>
  $(<span class="hljs-string">'&lt;button&gt;&lt;/button&gt;'</span>)
  .html(BUTTON_LABEL).css</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>ShinyLoot’s buttons are a chimeric grab-bag and
the nicest looking ones have site-provided CSS
that’s tied to markup using <code>&lt;ul&gt;</code> and <code>&lt;li&gt;</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-attribute">background</span>: <span class="hljs-string">'url("/images/filters/sort-background-inactive.png") '</span> +
                <span class="hljs-string">'repeat-x scroll 0% 0% transparent'</span>
    <span class="hljs-attribute">border</span>: <span class="hljs-string">'1px solid #666'</span>
    <span class="hljs-attribute">borderRadius</span>: <span class="hljs-string">'2px'</span>
    <span class="hljs-attribute">boxShadow</span>: <span class="hljs-string">'0px 1px 6px #777'</span>
    <span class="hljs-attribute">color</span>: <span class="hljs-string">'#222'</span>
    <span class="hljs-attribute">fontSize</span>: <span class="hljs-string">'12px'</span>
    <span class="hljs-attribute">fontWeight</span>: <span class="hljs-string">'bold'</span>
    <span class="hljs-attribute">fontFamily</span>: <span class="hljs-string">'Arial,Helvetica,Sans-serif'</span>
    <span class="hljs-attribute">float</span>: <span class="hljs-string">'right'</span>
    <span class="hljs-attribute">padding</span>: <span class="hljs-string">'2px 8px'</span>
    <span class="hljs-attribute">marginRight</span>: <span class="hljs-string">'-6px'</span>
    <span class="hljs-attribute">verticalAlign</span>: <span class="hljs-string">'middle'</span>
  .appendTo(<span class="hljs-string">'#content .header'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Scrapers are looked up first by domain (lightweight) and then by
a regex check on the URL (accurate).
This should allow for extremely robust scaling as well as enabling the
possibility of a build script which automatically generates the
Greasemonkey <code>@include</code> lines.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>scrapers =
  <span class="hljs-string">'www.dotemu.com'</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Each profile can be an object or a list of objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-string">'https://www\\.dotemu\\.com/(en|fr|es)/user/?'</span>: [</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>The store being imported from</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-string">'source_id'</span>: <span class="hljs-string">'dotemu'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Each scraper must have a <code>game_list</code> method which returns…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-string">'game_list'</span>:<span class="hljs-function"> -&gt;</span>
          {</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>…one or both of <code>title</code> and <code>url</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-attribute">title</span>: attr(x, <span class="hljs-string">'title'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>We’re guaranteed an absolute URL if we use the DOM href property</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-attribute">url</span>: x.href</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>The stores which should be added to the user’s “owned on” list</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-attribute">sources</span>: [<span class="hljs-string">'dotemu'</span>]
          } <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> $(<span class="hljs-string">'div.my-games div.field-title a'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Each scraper must have an <code>insert_button</code> member which adds
a button to the DOM using <code>BUTTON_LABEL</code> and then returns
a jQuery wrapper so the click handler can be bound.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-string">'insert_button'</span>:<span class="hljs-function"> -&gt;</span> dotemu_add_button(<span class="hljs-string">'div.my-games h2.pane-title'</span>)
      ,
        <span class="hljs-string">'source_id'</span>: <span class="hljs-string">'dotemu'</span>
        <span class="hljs-string">'game_list'</span>:<span class="hljs-function"> -&gt;</span>
          {
            <span class="hljs-attribute">title</span>: attr(x, <span class="hljs-string">'title'</span>)
            <span class="hljs-attribute">url</span>: x.href
            <span class="hljs-attribute">sources</span>: [<span class="hljs-string">'dotemu'</span>]
          } <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> $(<span class="hljs-string">'div.user-wishlist .views-field-title-1 a'</span>)
        <span class="hljs-string">'insert_button'</span>:<span class="hljs-function"> -&gt;</span> dotemu_add_button(<span class="hljs-string">'.user-wishlist h2.pane-title'</span>)
        <span class="hljs-string">'is_wishlist'</span>: <span class="hljs-literal">true</span>
      ]

  <span class="hljs-string">'fireflowergames.com'</span>:
    <span class="hljs-string">'^http://fireflowergames\\.com/my-lists/(edit-my|view-a)-list/\\?.+'</span>:
      <span class="hljs-string">'source_id'</span>: <span class="hljs-string">'fireflower'</span>
      <span class="hljs-string">'game_list'</span>:<span class="hljs-function"> -&gt;</span>
        results = $(<span class="hljs-string">'table.wl-table tbody td.check-column input:checked'</span>)
          .parents(<span class="hljs-string">'tr'</span>).find(<span class="hljs-string">'td.product-name a'</span>)

        <span class="hljs-keyword">if</span> (!results.length)
          results = $(<span class="hljs-string">'table.wl-table td.product-name a'</span>)

        {
          <span class="hljs-attribute">title</span>: $(x).text().trim()
          <span class="hljs-attribute">url</span>: x.href
          <span class="hljs-attribute">sources</span>: [<span class="hljs-string">'fireflower'</span>]
        } <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> results
      <span class="hljs-string">'insert_button'</span>:<span class="hljs-function"> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>XXX: If you can debug the broken behaviour with <button>, please do.
I don’t have time.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        $(<span class="hljs-string">'&lt;a class="button"&gt;&lt;/a&gt;'</span>)
          .html(BUTTON_LABEL)
          .wrap(<span class="hljs-string">'&lt;td&gt;&lt;/td&gt;'</span>)
          .appendTo($(<span class="hljs-string">'table.wl-actions-table tbody:first'</span>).find(<span class="hljs-string">'tr:last'</span>))
      <span class="hljs-string">'is_wishlist'</span>: <span class="hljs-literal">true</span>

  <span class="hljs-string">'secure.gog.com'</span>:
    <span class="hljs-string">'^https://secure\\.gog\\.com/checkout/.+\\?R.+'</span>:
      <span class="hljs-string">'source_id'</span>: <span class="hljs-string">'gog'</span>
      <span class="hljs-string">'game_list'</span>:<span class="hljs-function"> -&gt;</span> {
        <span class="hljs-attribute">id</span>: $(x).attr(<span class="hljs-string">'id'</span>).substring(<span class="hljs-number">2</span>)
        <span class="hljs-attribute">title</span>: $(<span class="hljs-string">'.game-title-link'</span>, x).text().trim()
        <span class="hljs-attribute">sources</span>: [<span class="hljs-string">'gog'</span>]
      } <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> $(<span class="hljs-string">'.receipt__content .game-item'</span>)

      <span class="hljs-string">'insert_button'</span>:<span class="hljs-function"> -&gt;</span>
        $(<span class="hljs-string">"&lt;span class='social-btn'&gt;&lt;/span&gt;"</span>)
          .html(<span class="hljs-string">"""&lt;img class=\"social-icon\" src=\"<span class="hljs-subst">#{ITAD_12X12}</span>\"
                   alt='ITAD' style="width: 12px"&gt;Export"""</span>)
          .css</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>If you can figure out how to do this properly, be my guest</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-attribute">position</span>: <span class="hljs-string">'relative'</span>
            <span class="hljs-attribute">top</span>: -<span class="hljs-number">6</span>
          .prependTo($(<span class="hljs-string">'.receipt__social'</span>).filter(<span class="hljs-string">':first'</span>))

    <span class="hljs-string">'^https://secure\\.gog\\.com/account(/games(/(shelf|list))?)?/?(\\?|$)'</span>:
      <span class="hljs-string">'source_id'</span>: <span class="hljs-string">'gog'</span>
      <span class="hljs-string">'game_list'</span>:<span class="hljs-function"> -&gt;</span>
        <span class="hljs-keyword">if</span> $(<span class="hljs-string">'.shelf_container'</span>).length &gt; <span class="hljs-number">0</span>
          gog_nonlist_parse()
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> $(<span class="hljs-string">'.games_list'</span>).length &gt; <span class="hljs-number">0</span>
          {
            <span class="hljs-attribute">id</span>: $(x).closest(<span class="hljs-string">'.game-item'</span>).attr(<span class="hljs-string">'id'</span>).substring(<span class="hljs-number">8</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>The list view mode only sees game titles easily</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-attribute">title</span>: x.textContent.trim()
            <span class="hljs-attribute">sources</span>: [<span class="hljs-string">'gog'</span>]
          } <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> $(<span class="hljs-string">'.game-title-link'</span>)

      <span class="hljs-string">'insert_button'</span>:<span class="hljs-function"> -&gt;</span>
        <span class="hljs-keyword">if</span> $(<span class="hljs-string">'.shelf_container'</span>).length &gt; <span class="hljs-number">0</span>
          $(<span class="hljs-string">"&lt;span class='shelf_btn'&gt;&lt;/button&gt;"</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Use GOG’s style but tweak it and force <em>both</em> ends round</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          .css
            <span class="hljs-attribute">float</span>: <span class="hljs-string">'right'</span>
            <span class="hljs-attribute">borderRadius</span>: <span class="hljs-string">'9px'</span>
            <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.7</span>
            <span class="hljs-attribute">marginTop</span>: <span class="hljs-string">'15px'</span>
            <span class="hljs-attribute">marginRight</span>: <span class="hljs-string">'-32px'</span>
          .html(BUTTON_LABEL)
          .prependTo($(<span class="hljs-string">'.shelf_header'</span>).filter(<span class="hljs-string">':first'</span>))
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> $(<span class="hljs-string">'.games_list'</span>).length &gt; <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Use GOG’s style class but force it to be its own tweaked
button group because their style won’t round both ends
of the same button</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          $(<span class="hljs-string">"&lt;span class='list_btn'&gt;&lt;/span&gt;"</span>)
          .css({ <span class="hljs-attribute">float</span>: <span class="hljs-string">'right'</span>, <span class="hljs-attribute">borderRadius</span>: <span class="hljs-string">'9px'</span> })
          .html(BUTTON_LABEL)</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Prevent it from throwing off the other group</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          .wrap(<span class="hljs-string">'&lt;span&gt;&lt;/span&gt;'</span>)
          .appendTo(<span class="hljs-string">'.list_header'</span>)
    <span class="hljs-string">'^https://secure\\.gog\\.com/account/wishlist'</span>:
      <span class="hljs-string">'source_id'</span>: <span class="hljs-string">'gog'</span>
      <span class="hljs-string">'game_list'</span>: gog_nonlist_parse
      <span class="hljs-string">'insert_button'</span>:<span class="hljs-function"> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Borrow the styling from the games list since I couldn’t find
anything better in GOG’s own styling.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        $(<span class="hljs-string">"&lt;span class='list_btn'&gt;&lt;/span&gt;"</span>)
        .css({ <span class="hljs-attribute">float</span>: <span class="hljs-string">'right'</span>, <span class="hljs-attribute">borderRadius</span>: <span class="hljs-string">'9px'</span> })
        .html(BUTTON_LABEL)</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Prevent it from throwing off the other group</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        .wrap(<span class="hljs-string">'&lt;span&gt;&lt;/span&gt;'</span>)
        .appendTo(<span class="hljs-string">'.wlist_header'</span>)
      <span class="hljs-string">'is_wishlist'</span>: <span class="hljs-literal">true</span>

  <span class="hljs-string">'groupees.com'</span>:
    <span class="hljs-string">'https?://(www\\.)?groupees\\.com/users/\\d+'</span>:
      <span class="hljs-string">'source_id'</span>: <span class="hljs-string">'other'</span>
      <span class="hljs-string">'game_list'</span>:<span class="hljs-function"> -&gt;</span>
        {
          <span class="hljs-attribute">title</span>: x.textContent.trim(),
          <span class="hljs-attribute">sources</span>: [<span class="hljs-string">'other'</span>]
        } <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> $(<span class="hljs-string">'.product .download-dropdown'</span>)
                    .parents(<span class="hljs-string">'.details'</span>).find(<span class="hljs-string">'h3'</span>)
      <span class="hljs-string">'insert_button'</span>:<span class="hljs-function"> -&gt;</span>
        $(<span class="hljs-string">"&lt;button&gt;&lt;/button&gt;"</span>)
          .css({ <span class="hljs-attribute">float</span>: <span class="hljs-string">'right'</span> }).addClass(<span class="hljs-string">'button'</span>)
          .html(BUTTON_LABEL + <span class="hljs-string">" (Selected Bundle)"</span>)
          .insertBefore(<span class="hljs-string">"input[name='search']"</span>)

  <span class="hljs-string">'www.humblebundle.com'</span>:
    <span class="hljs-string">'https://www\\.humblebundle\\.com/home/?'</span>:
      <span class="hljs-string">'source_id'</span>: <span class="hljs-string">'humblestore'</span>
      <span class="hljs-string">'game_list'</span>: humble_parse
      <span class="hljs-string">'insert_button'</span>:<span class="hljs-function"> -&gt;</span>
        humble_make_button().css
          <span class="hljs-attribute">float</span>: <span class="hljs-string">'right'</span>,
          <span class="hljs-attribute">fontSize</span>: <span class="hljs-string">'14px'</span>,
          <span class="hljs-attribute">fontWeight</span>: <span class="hljs-string">'normal'</span>
        .prependTo(<span class="hljs-string">'.base-main-wrapper h1'</span>)

    <span class="hljs-string">'https://www\\.humblebundle\\.com/(download)?s\\?key=.+'</span>:
      <span class="hljs-string">'source_id'</span>: <span class="hljs-string">'humblestore'</span>
      <span class="hljs-string">'game_list'</span>: humble_parse
      <span class="hljs-string">'insert_button'</span>:<span class="hljs-function"> -&gt;</span>
        parent = $(<span class="hljs-string">'.js-gamelist-holder'</span>).parents(<span class="hljs-string">'.whitebox'</span>)
        parent.find(<span class="hljs-string">'.staple.s4'</span>).remove()

        humble_make_button().css
          <span class="hljs-attribute">position</span>: <span class="hljs-string">'absolute'</span>
          <span class="hljs-attribute">top</span>: <span class="hljs-number">11</span>
          <span class="hljs-attribute">right</span>: <span class="hljs-number">17</span>
        .appendTo(parent)


  <span class="hljs-string">'indiegamestand.com'</span>:
    <span class="hljs-string">'https://indiegamestand\\.com/wallet\\.php'</span>:
      <span class="hljs-string">'source_id'</span>: <span class="hljs-string">'indiegamestand'</span>
      <span class="hljs-string">'game_list'</span>:<span class="hljs-function"> -&gt;</span>
        {</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p><strong>Note:</strong> IGS game URLs change during promos and some IGS wallet
entries may not have them (eg. entries just present to provide
a second steam key for some DLC from another entry)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-attribute">url</span>: $(<span class="hljs-string">'.game-thumb'</span>, x)?.closest(<span class="hljs-string">'a'</span>)?[<span class="hljs-number">0</span>]?.href
          <span class="hljs-attribute">title</span>: $(<span class="hljs-string">'.game-title'</span>, x).text().trim()
          <span class="hljs-attribute">sources</span>: [<span class="hljs-string">'indiegamestand'</span>]
        } <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> $(<span class="hljs-string">'#wallet_contents .line-item'</span>)

      <span class="hljs-string">'insert_button'</span>:<span class="hljs-function"> -&gt;</span>
        $(<span class="hljs-string">'&lt;div class="request key"&gt;&lt;/div&gt;'</span>)
        .html(BUTTON_LABEL).wrapInner(<span class="hljs-string">"&lt;div&gt;&lt;/div&gt;"</span>).css
          <span class="hljs-attribute">display</span>: <span class="hljs-string">'inline-block'</span>
          <span class="hljs-attribute">marginLeft</span>: <span class="hljs-string">'1em'</span>
          <span class="hljs-attribute">verticalAlign</span>: <span class="hljs-string">'middle'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>This would look nicer if floated right in <code>.titles</code> but
their button styles are scoped to <code>#game_wallet</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        .appendTo(<span class="hljs-string">'#game_wallet h2'</span>)

  <span class="hljs-string">'www.shinyloot.com'</span>:
    <span class="hljs-string">'https?://www\\.shinyloot\\.com/m/games/?'</span>:
      <span class="hljs-string">'source_id'</span>: <span class="hljs-string">'shinyloot'</span>
      <span class="hljs-string">'game_list'</span>:<span class="hljs-function"> -&gt;</span>
        {
          <span class="hljs-attribute">url</span>: $(<span class="hljs-string">'.right-float a img'</span>, x).closest(<span class="hljs-string">'a'</span>)[<span class="hljs-number">0</span>].href
          <span class="hljs-attribute">title</span>: $(x).prev(<span class="hljs-string">'h3'</span>).text().trim()
          <span class="hljs-attribute">sources</span>: [<span class="hljs-string">'shinyloot'</span>]
        } <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> $(<span class="hljs-string">'#accordion .ui-widget-content'</span>)
      <span class="hljs-string">'insert_button'</span>: shinyloot_insert_button
    <span class="hljs-string">'https?://www\\.shinyloot\\.com/m/wishlist/?'</span>:
      <span class="hljs-string">'source_id'</span>: <span class="hljs-string">'shinyloot'</span>
      <span class="hljs-string">'game_list'</span>:<span class="hljs-function"> -&gt;</span>
        {
          <span class="hljs-attribute">url</span>: $(<span class="hljs-string">'.gameInfo + a'</span>, x)[<span class="hljs-number">0</span>].href
          <span class="hljs-attribute">title</span>: $(<span class="hljs-string">'.gameName'</span>, x).text().trim()
        } <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> $(<span class="hljs-string">'.gameItem'</span>)
      <span class="hljs-string">'insert_button'</span>: shinyloot_insert_button
      <span class="hljs-string">'is_wishlist'</span>: <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Callback for the button</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">scrapeGames</span> = <span class="hljs-params">(scraper_obj)</span> -&gt;</span>
  params = {
    <span class="hljs-attribute">json</span>: JSON.stringify(scraper_obj.game_list()),
    <span class="hljs-attribute">source</span>: scraper_obj.source_id
  }

  url = <span class="hljs-keyword">if</span> scraper_obj.is_wishlist?
    <span class="hljs-string">'http://isthereanydeal.com/outside/user/wait/3rdparty'</span>
  <span class="hljs-keyword">else</span>
    <span class="hljs-string">'http://isthereanydeal.com/outside/user/collection/3rdparty'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p><strong>TODO:</strong> Figure out why attempting to use an iframe for non-HTTPS sites
navigates the top-level window.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  form = $(<span class="hljs-string">"&lt;form id='itad_submitter' method='POST' /&gt;"</span>).attr(<span class="hljs-string">'action'</span>, url)
  params[<span class="hljs-string">'returnTo'</span>] = location.href</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Submit the form data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  form.css({ <span class="hljs-attribute">display</span>: <span class="hljs-string">'none'</span> })
  $.each params, <span class="hljs-function"><span class="hljs-params">(key, value)</span> -&gt;</span>
    $(<span class="hljs-string">"&lt;input type='hidden' /&gt;"</span>)
      .attr(<span class="hljs-string">"name"</span>, key)
      .attr(<span class="hljs-string">"value"</span>, value)
      .appendTo(form)
  $(<span class="hljs-built_in">document</span>.body).append(form)

  form.submit()</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>CoffeeScript shorthand for <code>$(document).ready(function() {</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>$<span class="hljs-function"> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Resolve and call the correct profile</p>
<p>It seems we don’t need an explicit <code>if location.host of scrapers</code>
before the <code>for</code> loop</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Loading ITAD importer..."</span>)
  <span class="hljs-keyword">if</span> scrapers[location.host]
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Matched domain: "</span> + location.host)
    <span class="hljs-keyword">for</span> regex, profile <span class="hljs-keyword">of</span> scrapers[location.host]
      <span class="hljs-keyword">try</span>
        profile_matched = location.href.match(regex)
      <span class="hljs-keyword">catch</span> e
        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Bad regex: "</span> + regex)

      <span class="hljs-keyword">if</span> profile_matched
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Matched profile: "</span> + regex)</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Allow reloading the script without reloading the page for RAD</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        $(<span class="hljs-string">'.itad_btn, #itad_dlg, .itad_close'</span>).remove()</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Simplify the following code</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> Array.isArray(profile)
          profile = [profile]

        <span class="hljs-keyword">for</span> scraper <span class="hljs-keyword">in</span> profile</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>We’ll need a closure to ensure click() calls the proper scraper</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">do</span> <span class="hljs-function"><span class="hljs-params">(scraper)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Use the <code>?</code> existential operator to die quietly if the scraper
doesn’t have an <code>insert_button</code> member.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            scraper.insert_button?().addClass(<span class="hljs-string">'itad_btn'</span>).click<span class="hljs-function"> -&gt;</span>
              scrapeGames(scraper)</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>We only ever want to match one profile so break here</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">break</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
